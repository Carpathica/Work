import os
import shutil
from ultralytics import YOLO
from ray import tune

# üìÇ –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
RESULTS_DIR = "train_results"
os.makedirs(RESULTS_DIR, exist_ok=True)

# üîπ –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –º–æ–¥–µ–ª–µ–π
training_configs = [
    {
        "name": "exp_nano",
        "model_path": "yolov8n.pt",
        "tune": True,
        "tune_epochs": 30,
        "tune_samples": 20,
        "train_epochs": 150,
        "batch": 16,
        "imgsz": 640,
        "lr": 0.01
    },
    {
        "name": "exp_small",
        "model_path": "yolov8s.pt",
        "tune": False,      # –ø—Ä–æ—Å—Ç–æ –æ–±—ã—á–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ
        "train_epochs": 120,
        "batch": 12,
        "imgsz": 640,
        "lr": 0.005
    }
]

# üîπ –ü—É—Ç—å –∫ –≤–∞—à–µ–º—É –¥–∞—Ç–∞—Å–µ—Ç—É
dataset_yaml = "data/my_dataset.yaml"

# üîπ –ü—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è
for cfg in training_configs:
    exp_name = f"train_{cfg['name']}"
    print(f"\n=== –†–∞–±–æ—Ç–∞–µ–º —Å –º–æ–¥–µ–ª—å—é {cfg['model_path']} (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç: {exp_name}) ===")

    # –ó–∞–≥—Ä—É–∂–∞–µ–º pretrained –º–æ–¥–µ–ª—å
    model = YOLO(cfg["model_path"])

    best_params = {}  # —Å—é–¥–∞ –∑–∞–ø–∏—à–µ–º –ª—É—á—à–∏–µ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Å–ª–µ —Ç—é–Ω–∏–Ω–≥–∞

    # üîπ –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ç—é–Ω–∏–Ω–≥
    if cfg.get("tune", False):
        print(f"--- –ó–∞–ø—É—Å–∫ —Ç—é–Ω–∏–Ω–≥–∞ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è {cfg['name']} ---")

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ search space (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
        tune_space = {
            "lr0": tune.uniform(1e-5, 1e-1),
            "weight_decay": tune.uniform(0.0, 1e-3),
            "momentum": tune.uniform(0.6, 0.98)
        }

        # –ó–∞–ø—É—Å–∫ —Ç—é–Ω–∏–Ω–≥–∞
        tune_result = model.tune(
            data=dataset_yaml,
            use_ray=True,
            space=tune_space,
            gpu_per_trial=1,
            max_samples=cfg["tune_samples"],
            train_args={"epochs": cfg["tune_epochs"]},
            val=True,
            save=True
        )

        # –ü–æ–ª—É—á–∞–µ–º –ª—É—á—à–∏–µ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        best_params = tune_result.best_config
        print(f"–õ—É—á—à–∏–µ –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è {cfg['name']}: {best_params}")

    # üîπ –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ
    print(f"--- –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ {cfg['name']} ---")

    # –ë–µ—Ä—ë–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ —Ç—é–Ω–∏–Ω–≥–∞ –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
    train_args = {
        "data": dataset_yaml,
        "epochs": cfg["train_epochs"],
        "batch": cfg["batch"],
        "imgsz": cfg["imgsz"],
        "lr": cfg.get("lr", 0.01),
        "project": "runs/train",
        "name": exp_name
    }

    # –ï—Å–ª–∏ –µ—Å—Ç—å best_params –ø–æ—Å–ª–µ —Ç—é–Ω–∏–Ω–≥–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
    if best_params:
        train_args.update(best_params)

    # –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è
    model.train(**train_args)

    # üîπ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å–∞
    run_dir = os.path.join("runs", "train", exp_name)
    weights_dir = os.path.join(run_dir, "weights")
    best_weight = os.path.join(weights_dir, "best.pt")
    last_weight = os.path.join(weights_dir, "last.pt")

    out_best = os.path.join(RESULTS_DIR, f"{exp_name}.pt")
    out_last = os.path.join(RESULTS_DIR, f"{exp_name}_last.pt")

    if os.path.exists(best_weight):
        shutil.copyfile(best_weight, out_best)
        print(f"‚úÖ –°–æ—Ö—Ä–∞–Ω—ë–Ω –ª—É—á—à–∏–π –≤–µ—Å: {out_best}")
    if os.path.exists(last_weight):
        shutil.copyfile(last_weight, out_last)
        print(f"üîÅ –°–æ—Ö—Ä–∞–Ω—ë–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–µ—Å: {out_last}")

    print(f"=== –ó–∞–≤–µ—Ä—à–µ–Ω–æ –æ–±—É—á–µ–Ω–∏–µ {cfg['name']} ===\n")
